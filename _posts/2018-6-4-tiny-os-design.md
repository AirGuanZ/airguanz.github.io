---
layout: post
title: TinyOS实现总结
key: 20180604
tags:
  - OS
---

一只菜鸡的操作系统之旅

<!--more-->

## 引言

我很久以前就从一些像《Modern Operating System》这样的教材中学习过一点操作系统的皮毛，它们大多“居高临下”地陈列各种算法，这么做固然有利于理解原理，但过于high-level的描述让我读之犹如隔靴瘙痒，不够痛快。这个学期有操作系统课程，索性实践实践，亲手编写了一个玩具内核“TinyOS”。

在开始这个项目之前，我甚至没有使用任何Linux发行版的经验，因此TinyOS在设计上和Linux相去甚远，谈不上“类Unix”。也正因如此，TinyOS中有许多外人看来不可理喻的设计，它们是作为一个系统菜鸡的我摸着石头过河留下的痕迹。这篇文章也是批判性的，用来吐槽TinyOS中的种种奇葩设计，也算是我获益良多的证明吧。

时至今日，TinyOS已经支持以下特性：

1. 分页内存管理
2. 抢占式线程调度
3. 进程资源管理
4. 进程消息队列
5. 信号量和自旋锁
6. 键盘驱动程序
7. 分区管理和文件系统
8. Explorer（用户交互界面）
9. 进程屏幕缓冲区切换
10. 管道

外部文件可以通过专门编写的小工具导入到TinyOS磁盘映像的文件系统中（很不幸，TinyOS并不支持U盘这样的功能，只能通过这种扭曲的方式来和外部交换文件）。我已经为之编写了以下应用程序：

1. 诸如ls，cp，mkdir等命令，它们以elf的形式存放在TinyOS文件系统的特定目录中
2. ed，一个简单的编辑器，能让我在TinyOS下创建和修改文本文件
3. help，能够在在特定目录下搜索指定条目的帮助文档并在屏幕上呈现

运行时截图如下：

![]({{site.url}}/postpics/tiny-os/01-explorer.png){: width="70%"}

![]({{site.url}}/postpics/tiny-os/02-ed.png){: width="70%"}

在未来的一两个月内，我计划为TinyOS添加一个编程语言的解释器（它至少得能够自举），实现我在TinyOS上编写代码并运行的梦想。在自己的操作系统上用自己的语言编写程序，并用自己的编译器/解释器运行，这是何等浪漫的事情啊！

## 模块简介

TinyOS整体结构如下图所示：

TODO

不得不承认我根本想不到像块设备和字符设备这样绝妙的接口设计，这导致TinyOS中缺乏必要的抽象层。我的野心和视野的确还不足以推动自己去用极少的界面抽象一切可访问的对象，大概这需要在信心和能力上的双重进步吧。
