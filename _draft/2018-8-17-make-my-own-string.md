---
title: 字符串类实现心得
key: 20180817
tags:
  - C/C++
---

众所周知，C++标准库的字符串组件就是个残废，很多项目都会造个自己的字符串轮子（比如Qt的QString）。最近我也以练习为目的写了个字符串类，一开始想的是以后可以长期使用，现在看来这东西还是略微超出了我的能力范围，轮子造得并不圆。尽管如此，还是把记一下教训和收获。

<!--more-->

## 字符编码

我并不打算在所有的字符串中使用统一的编码、仅在输入输出时做编码转换，而是将字符编码作为字符串类型的模板参数处理。后一种方案比前一种更加灵活，实现起来也更为困难。不过既然是练习，做不做得出来是次要的，就是要迎难而上。

首先，每种字符编码方案都有它的code unit（码元）和code point（码点），其中码点是用来表示一个字符的单元，码元则是用来对码点进行具体编码的单元。比如，在UTF-8中，汉字“今”的码点是`0x4ECA`，其具体编码由三个字节构成，这三个字节就是三个码元。一个码点就对应了一个字符，有可能需要多个码元才能编码一个字符。

我首先给出了UTF-8、UTF-16、UTF-32三种编码方案对应的类，其码点都是`char32_t`类型，用来表示一个Unicode字符，码元则以模板参数充当——

{% highlight c++ %}
template<typename CU>
class UTF8Core
{
public:
    using CodePoint = char32_t;
    using CodeUnit  = CU;
    
    //...
};
{% endhighlight %}

事实证明这个模板参数纯粹是我脑抽的产物，它除了让我多打了很多字、让编译变慢之外，没有任何别的效果。所以在引入抽象层前一定要先想清楚这个抽象是不是必要的，不能因为模板无运行时开销就滥用。


